<?xml version="1.0" encoding="UTF-8"?>
<Patch>

  <!-- Pre Patches - that adds work types to mechanoids -->

  <!-- ExGT Bio Mechanoid work types addon -->
  <Operation Class="XmlExtensions.FindMod">
    <mods>
      <li>xmb.breadmech</li>
    </mods>
    <packageId>True</packageId>
    <caseTrue>
      <Operation Class="XmlExtensions.OptionalPatch">
        <modId>Rhynia.Mod.Misc</modId>
        <key>Misc_BM_MechEnhance</key>
        <defaultValue>False</defaultValue>
        <caseTrue>

          <!-- Croissant -->

          <Operation Class="XmlExtensions.HybridPatch">
            <xpath>/Defs/ThingDef[defName = "BM_Croissant"]</xpath>
            <value>
              <statBases Operation="Safe">
                <MoveSpeed Operation="AddOrReplace">5.5</MoveSpeed>
              </statBases>
              <race Operation="Safe">
                <mechEnabledWorkTypes Operation="Safe">
                  <li Operation="SafeAdd" Compare="InnerText">BasicWorker</li>
                  <li Operation="SafeAdd" Compare="InnerText">Doctor</li>
                </mechEnabledWorkTypes>
              </race>
            </value>
          </Operation>

          <!-- BakedBun -->

          <Operation Class="XmlExtensions.HybridPatch">
            <xpath>/Defs/ThingDef[defName = "BM_BakedBun"]</xpath>
            <value>
              <statBases Operation="Safe">
                <WorkSpeedGlobal Operation="SafeAdd">1.1</WorkSpeedGlobal>
              </statBases>
              <race Operation="Safe">
                <mechEnabledWorkTypes Operation="Safe">
                  <li Operation="SafeAdd" Compare="InnerText">Hauling</li>
                  <li Operation="SafeAdd" Compare="InnerText" MayRequire="nalzurin.moremechanitormechs20">Warden</li>
                </mechEnabledWorkTypes>
              </race>
            </value>
          </Operation>

          <!-- SoftRoll -->

          <Operation Class="XmlExtensions.HybridPatch">
            <xpath>/Defs/ThingDef[defName = "BM_SoftRoll"]</xpath>
            <value>
              <statBases Operation="Safe">
                <MoveSpeed Operation="AddOrReplace">4.8</MoveSpeed>
                <WorkSpeedGlobal Operation="SafeAdd">1.2</WorkSpeedGlobal>
              </statBases>
              <race Operation="Safe">
                <mechEnabledWorkTypes Operation="Safe">
                  <li Operation="SafeAdd" Compare="InnerText" MayRequire="nalzurin.moremechanitormechs20">Hunting</li>
                </mechEnabledWorkTypes>
              </race>
            </value>
          </Operation>

          <!-- Puff -->

          <Operation Class="XmlExtensions.HybridPatch">
            <xpath>/Defs/ThingDef[defName = "BM_Puff"]</xpath>
            <value>
              <statBases Operation="Safe">
                <MoveSpeed Operation="AddOrReplace">4.8</MoveSpeed>
                <WorkSpeedGlobal Operation="SafeAdd">1.15</WorkSpeedGlobal>
              </statBases>
              <race Operation="Safe">
                <mechEnabledWorkTypes Operation="Safe">
                  <li Operation="SafeAdd" Compare="InnerText" MayRequire="nalzurin.moremechanitormechs20">Handling</li>
                  <li Operation="SafeAdd" Compare="InnerText" MayRequire="nalzurin.moremechanitormechs20">Research</li>
                </mechEnabledWorkTypes>
              </race>
            </value>
          </Operation>

          <!-- WitchBread -->

          <Operation Class="XmlExtensions.HybridPatch">
            <xpath>/Defs/ThingDef[defName = "BM_WitchBread"]</xpath>
            <value>
              <statBases Operation="Safe">
                <MoveSpeed Operation="AddOrReplace">4.6</MoveSpeed>
                <WorkSpeedGlobal Operation="SafeAdd">1.2</WorkSpeedGlobal>
              </statBases>
              <race Operation="Safe">
                <mechEnabledWorkTypes Operation="Safe">
                  <li Operation="SafeAdd" Compare="InnerText">Smithing</li>
                  <li Operation="SafeAdd" Compare="InnerText">Tailoring</li>
                  <li Operation="SafeAdd" Compare="InnerText">Crafting</li>
                  <li Operation="SafeAdd" Compare="InnerText">Art</li>
                </mechEnabledWorkTypes>
              </race>
            </value>
          </Operation>

        </caseTrue>
      </Operation>
    </caseTrue>
  </Operation>

  <!-- Post Patches - that modifies work types to mechanoids -->

  <Operation Class="XmlExtensions.IfStatement">

    <!-- These settings needs widely apply to all mechanoids. -->

    <condition Class="XmlExtensions.Boolean.Or">
      <conditions>
        <li Class="XmlExtensions.Boolean.Comparison">
          <modId>Rhynia.Mod.Misc</modId>
          <value1>Biotech_TweakMechWork</value1>
          <value2>True</value2>
          <isKey1>True</isKey1>
          <nonNumeric>True</nonNumeric>
        </li>
        <li Class="XmlExtensions.Boolean.Comparison">
          <modId>Rhynia.Mod.Misc</modId>
          <value1>Biotech_FabricorWorkTypeArt</value1>
          <value2>True</value2>
          <isKey1>True</isKey1>
          <nonNumeric>True</nonNumeric>
        </li>
        <li Class="XmlExtensions.Boolean.Comparison">
          <modId>Rhynia.Mod.Misc</modId>
          <value1>Biotech_HaulingMechCarryMore</value1>
          <value2>True</value2>
          <isKey1>True</isKey1>
          <nonNumeric>True</nonNumeric>
        </li>
        <li Class="XmlExtensions.Boolean.Comparison">
          <modId>Rhynia.Mod.Misc</modId>
          <value1>Misc_MechHaulAlsoCapture</value1>
          <value2>True</value2>
          <isKey1>True</isKey1>
          <nonNumeric>True</nonNumeric>
        </li>
      </conditions>
    </condition>

    <caseTrue>

      <!-- Create all working mechanoids def document -->

      <Operation Class="XmlExtensions.CreateDocument">
        <docName>MechWorkList</docName>
        <xpath>/Defs/ThingDef[race/mechEnabledWorkTypes]</xpath>
      </Operation>

      <!-- Apply Biotech_FabricorWorkTypeArt -->

      <Operation Class="XmlExtensions.OptionalPatch">
        <modId>Rhynia.Mod.Misc</modId>
        <key>Biotech_FabricorWorkTypeArt</key>
        <defaultValue>False</defaultValue>
        <caseTrue>
          <Operation Class="XmlExtensions.PatchOperationSafeAdd">
            <xmlDoc>MechWorkList</xmlDoc>
            <xpath>/MechWorkList/ThingDef[race/mechEnabledWorkTypes[li = 'Smithing']]/race/mechEnabledWorkTypes</xpath>
            <compare>InnerText</compare>
            <value>
              <li>Art</li>
            </value>
          </Operation>
        </caseTrue>
      </Operation>

      <!-- Apply Misc_MechHaulAlsoUrgentHaul -->

      <Operation Class="XmlExtensions.OptionalPatch">
        <modId>Rhynia.Mod.Misc</modId>
        <key>Misc_MechHaulAlsoUrgentHaul</key>
        <defaultValue>False</defaultValue>
        <caseTrue>
          <Operation Class="XmlExtensions.FindMod">
            <mods>
              <li>keyz182.keyzallowutilities</li>
            </mods>
            <packageId>True</packageId>
            <caseTrue>
              <!-- Keyz' Allow Utilities -->
              <Operation Class="XmlExtensions.PatchOperationSafeAdd">
                <xmlDoc>MechWorkList</xmlDoc>
                <xpath>/MechWorkList/ThingDef[race/mechEnabledWorkTypes[li = 'Hauling']]/race/mechEnabledWorkTypes</xpath>
                <compare>InnerText</compare>
                <value>
                  <li>KAU_UrgentHaul</li>
                </value>
              </Operation>
            </caseTrue>
            <caseFalse>
              <!-- Allow Tool -->
              <Operation Class="XmlExtensions.FindMod">
                <mods>
                  <li>unlimitedhugs.allowtool</li>
                </mods>
                <packageId>True</packageId>
                <caseTrue>
                  <Operation Class="XmlExtensions.PatchOperationSafeAdd">
                    <xmlDoc>MechWorkList</xmlDoc>
                    <xpath>/MechWorkList/ThingDef[race/mechEnabledWorkTypes/[li = 'Hauling']]/race/mechEnabledWorkTypes</xpath>
                    <compare>InnerText</compare>
                    <value>
                      <li>HaulingUrgent</li>
                    </value>
                  </Operation>
                </caseTrue>
              </Operation>
            </caseFalse>
          </Operation>
        </caseTrue>
      </Operation>

      <!-- Apply Misc_MechHaulAlsoCapture -->

      <Operation Class="XmlExtensions.OptionalPatch">
        <modId>Rhynia.Mod.Misc</modId>
        <key>Misc_MechHaulAlsoCapture</key>
        <defaultValue>False</defaultValue>
        <caseTrue>
          <Operation Class="XmlExtensions.FindMod">
            <mods>
              <li>lke.smarter.CaptureThem</li>
            </mods>
            <packageId>True</packageId>
            <caseTrue>
              <!-- Smart Capture Them: Allow hauling and doctor mechanoids -->
              <Operation Class="XmlExtensions.PatchOperationSafeAdd">
                <xmlDoc>MechWorkList</xmlDoc>
                <xpath>/MechWorkList/ThingDef[race/mechEnabledWorkTypes[li = 'Hauling' or li = 'Doctor']]/race/mechEnabledWorkTypes</xpath>
                <compare>InnerText</compare>
                <value>
                  <li>CaptureThemCapture</li>
                </value>
              </Operation>
            </caseTrue>
            <caseFalse>
              <!-- Fall back - Mlie's Capture Them: Allow hauling mechanoids -->
              <Operation Class="XmlExtensions.FindMod">
                <mods>
                  <li>mlie.CaptureThem</li>
                </mods>
                <packageId>True</packageId>
                <caseTrue>
                  <Operation Class="XmlExtensions.PatchOperationSafeAdd">
                    <xmlDoc>MechWorkList</xmlDoc>
                    <xpath>/MechWorkList/ThingDef[race/mechEnabledWorkTypes/[li = 'Hauling']]/race/mechEnabledWorkTypes</xpath>
                    <compare>InnerText</compare>
                    <value>
                      <li>CaptureThemCapture</li>
                    </value>
                  </Operation>
                </caseTrue>
              </Operation>
            </caseFalse>
          </Operation>
        </caseTrue>
      </Operation>

      <!-- Apply Biotech_HaulingMechCarryMore -->
      <Operation Class="XmlExtensions.OptionalPatch">
        <modId>Rhynia.Mod.Misc</modId>
        <key>Biotech_HaulingMechCarryMore</key>
        <defaultValue>False</defaultValue>
        <caseTrue>
          <Operation Class="XmlExtensions.PatchOperationAddOrReplace">
            <xmlDoc>MechWorkList</xmlDoc>
            <xpath>/MechWorkList/ThingDef[race/mechEnabledWorkTypes[li = 'Hauling']]/statBases</xpath>
            <value>
              <CarryingCapacity>800</CarryingCapacity>
            </value>
          </Operation>
        </caseTrue>
      </Operation>

      <!-- Apply Biotech_TweakMechWork -->

      <Operation Class="XmlExtensions.OptionalPatch">
        <modId>Rhynia.Mod.Misc</modId>
        <key>Biotech_TweakMechWork</key>
        <defaultValue>False</defaultValue>
        <caseTrue>
          <Operation Class="XmlExtensions.UseSetting">
            <modId>Rhynia.Mod.Misc</modId>
            <key>Biotech_TweakMechWork_Speed</key>
            <defaultValue>1.0</defaultValue>
            <apply>
              <Operation Class="XmlExtensions.PatchOperationAddOrReplace">
                <xmlDoc>MechWorkList</xmlDoc>
                <xpath>/MechWorkList/ThingDef/statBases</xpath>
                <value>
                  <WorkSpeedGlobal>{Biotech_TweakMechWork_Speed}</WorkSpeedGlobal>
                </value>
              </Operation>
            </apply>
          </Operation>

          <Operation Class="XmlExtensions.UseSetting">
            <modId>Rhynia.Mod.Misc</modId>
            <key>Biotech_TweakMechWork_Skill</key>
            <defaultValue>10</defaultValue>
            <apply>
              <Operation Class="XmlExtensions.PatchOperationAddOrReplace">
                <xmlDoc>MechWorkList</xmlDoc>
                <xpath>/MechWorkList/ThingDef/race</xpath>
                <value>
                  <mechFixedSkillLevel>{Biotech_TweakMechWork_Skill}</mechFixedSkillLevel>
                </value>
              </Operation>
            </apply>
          </Operation>
        </caseTrue>
      </Operation>

      <!-- Finalize patch -->

      <Operation Class="XmlExtensions.MergeDocument">
        <docName>MechWorkList</docName>
      </Operation>
    </caseTrue>
  </Operation>

  <!-- Other patches - that does not directly relate to mechanoids -->

  <Operation Class="XmlExtensions.OptionalPatch">
    <modId>Rhynia.Mod.Misc</modId>
    <key>Biotech_FasterMechForming</key>
    <defaultValue>False</defaultValue>
    <caseTrue>
      <Operation Class="XmlExtensions.PatchOperationAddOrReplace">
        <xpath>/Defs/StatDef[defName = "MechFormingSpeed"]/defaultBaseValue</xpath>
        <value>
          <defaultBaseValue>20</defaultBaseValue>
        </value>
      </Operation>
      <Operation Class="PatchOperationReplace">
        <xpath>/Defs/RecipeDef[gestationCycles]/gestationCycles</xpath>
        <value>
          <gestationCycles>1</gestationCycles>
        </value>
      </Operation>
    </caseTrue>
  </Operation>

  <Operation Class="XmlExtensions.OptionalPatch">
    <modId>Rhynia.Mod.Misc</modId>
    <key>Biotech_VatLearningPowerful</key>
    <defaultValue>False</defaultValue>
    <caseTrue>
      <Operation Class="PatchOperationReplace">
        <xpath>Defs/HediffDef[defName = "VatLearning"]/comps/li[@Class = "HediffCompProperties_SeverityPerDay"]/severityPerDay</xpath>
        <value>
          <severityPerDay>60000</severityPerDay>
        </value>
      </Operation>
    </caseTrue>
  </Operation>

  <Operation Class="XmlExtensions.OptionalPatch">
    <modId>Rhynia.Mod.Misc</modId>
    <key>Biotech_WastepackFastProcess</key>
    <defaultValue>False</defaultValue>
    <caseTrue>

      <!-- Biotech -->

      <Operation Class="XmlExtensions.HybridPatch">
        <xpath>/Defs/ThingDef[defName = "WastepackAtomizer"]</xpath>
        <value>
          <comps Operation="Safe">
            <li Class="CompProperties_Atomizer" Operation="Safe" CheckAttributes="True">
              <stackLimit Operation="SafeReplace">400</stackLimit>
              <ticksPerAtomize Operation="SafeReplace">6000</ticksPerAtomize>
            </li>
          </comps>
        </value>
      </Operation>

      <!-- VRE -->

      <Operation Class="XmlExtensions.FindMod">
        <mods>
          <li>vanillaexpanded.recycling</li>
        </mods>
        <packageId>True</packageId>
        <caseTrue>

          <Operation Class="PatchOperationReplace">
            <xpath>/Defs/PipeSystem.ProcessDef[defName = 'VRecyclingE_TrashToBricks']/ticks</xpath>
            <value>
              <ticks>6000</ticks>
            </value>
          </Operation>
          <Operation Class="XmlExtensions.HybridPatch">
            <xpath>/Defs/ThingDef[defName = "VRecyclingE_GarbageCompactor"]</xpath>
            <value>
              <comps Operation="Safe">
                <li Class="VanillaRecyclingExpanded.CompProperties_SuperSimpleProcessor" Operation="Safe" CheckAttributes="True">
                  <ticksToFinish Operation="Replace">750</ticksToFinish>
                </li>
              </comps>
            </value>
          </Operation>

          <Operation Class="PatchOperationReplace">
            <xpath>/Defs/PipeSystem.ProcessDef[defName = 'VRecyclingE_SplitStabilizedAlloypack']/ticks</xpath>
            <value>
              <ticks>3000</ticks>
            </value>
          </Operation>
          <Operation Class="XmlExtensions.HybridPatch">
            <xpath>/Defs/ThingDef[defName = "VRecyclingE_AlloypackSplitter"]</xpath>
            <value>
              <comps Operation="Safe">
                <li Class="VanillaRecyclingExpanded.CompProperties_SuperSimpleProcessor" Operation="Safe" CheckAttributes="True">
                  <ticksToFinish Operation="Replace">3000</ticksToFinish>
                </li>
              </comps>
            </value>
          </Operation>

        </caseTrue>
      </Operation>

    </caseTrue>
  </Operation>
</Patch>